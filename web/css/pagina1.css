OQ FALTA:

--- Arrumar descrição nas páginas de busca
--- Arrumar css - para % (no caso da resolução do projetor)
--- Verificações + forms (corrigir alguns detalhes, ex: "Deu Certo", ver o tipo de envio. Colocar verificação nas páginas de retorno)
--- Gerar paginação
--- Gerar Gráficos (Oq vai ter gráfico?)
--- Otimizar as Consultas
--- Arrumar Relatório de LabBD
--- Se possível, deixar responsivo.


--OBSERVAÇÕES PARA FUNCIONAR:
Banco de Dados deve se chamar DAG. Se sua senha não for "senha" troque no ConnectionFactory e nos avise hehe
Consulta por subdominio: Procedure deve estar no BD e se chamar consulta1
Consulta por dominio: Criar a procedure: consultaDominio().
Consulta por progrma: Procedure deve estar criada no BD e se chamar consulta2

-------QUERYS ATUALIZADAS:
	
CREATE OR REPLACE FUNCTION ConsultaDominio(descricao text, val NUMERIC) RETURNS TABLE (nomePrograma VARCHAR, gasto NUMERIC) AS $$
DECLARE 
	descr varchar = '%' || descricao || '%';
BEGIN
RETURN QUERY
	select descricaointernamunicipio, valor 
	from programa p,(
		select codigoprograma, valor 
		from despesa de, dominio dom 
		where valor >= val 
		and dom.descricao ILIKE descr 
		and dom.codigo = de.codigodominio
		) AS parcial
	 where parcial.codigoprograma = p.codigo;
END;
$$ LANGUAGE plpgsql;

CREATE OR REPLACE FUNCTION Consulta2(codDom INTEGER, lim NUMERIC, opcOrdem VARCHAR) RETURNS TABLE (descricao VARCHAR, total NUMERIC) AS $$
BEGIN
	IF opcOrdem = 'programas' THEN
		RETURN QUERY 
		SELECT descricaointernamunicipio, sum 
		FROM programa, (SELECT codigoprograma, sum(valor) 
				FROM despesa de, dominio d 
				WHERE d.codigo = de.codigodominio 
				AND d.codigo = codDom
				GROUP BY codigoprograma 
				HAVING sum(valor) > lim) result 
		WHERE programa.codigo = result.codigoprograma 
		ORDER BY descricaointernamunicipio;
	ELSE 
		RETURN QUERY 
		SELECT descricaointernamunicipio, sum 
		FROM programa, (SELECT codigoprograma, sum(valor) 
				FROM despesa de, dominio d 
				WHERE d.codigo = de.codigodominio 
				AND d.codigo = codDom
				GROUP BY codigoprograma 
				HAVING sum(valor) > lim) result 
		WHERE programa.codigo = result.codigoprograma 
		ORDER BY sum DESC;
	END IF;
END;
$$ LANGUAGE plpgsql;